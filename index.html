<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cupra Assistent">
    <meta name="theme-color" content="#e94560">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Cupra Tavascan Assistent</title>
    <style>
        :root {
            --bg-start: #1a1a2e;
            --bg-end: #16213e;
            --text: white;
            --header-bg: rgba(0,0,0,0.3);
            --controls-bg: rgba(0,0,0,0.3);
            --border: rgba(255,255,255,0.1);
            --assistant-bg: rgba(255,255,255,0.1);
            --input-bg: rgba(255,255,255,0.1);
            --input-border: rgba(255,255,255,0.2);
            --modal-bg: #16213e;
            --status-color: rgba(255,255,255,0.7);
            --label-color: rgba(255,255,255,0.8);
        }

        body.light-mode {
            --bg-start: #f0f4f8;
            --bg-end: #dde6f0;
            --text: #1a1a2e;
            --header-bg: rgba(255,255,255,0.75);
            --controls-bg: rgba(255,255,255,0.75);
            --border: rgba(0,0,0,0.12);
            --assistant-bg: rgba(0,0,0,0.06);
            --input-bg: rgba(0,0,0,0.06);
            --input-border: rgba(0,0,0,0.2);
            --modal-bg: #ffffff;
            --status-color: rgba(0,0,0,0.55);
            --label-color: rgba(0,0,0,0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            transition: background 0.3s, color 0.3s;
        }

        .header {
            padding: 15px 20px;
            background: var(--header-bg);
            text-align: center;
            border-bottom: 2px solid #e94560;
            position: relative;
        }
        
        h1 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .setup-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
        }
        
        .setup-indicator.ready {
            background: #4ecca3;
        }
        
        .conversation {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 85%;
            animation: slideIn 0.3s ease;
            line-height: 1.5;
            font-size: 16px;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-message {
            background: #e94560;
            margin-left: auto;
            text-align: right;
        }
        
        .assistant-message {
            background: var(--assistant-bg);
            margin-right: auto;
        }

        .controls {
            padding: 20px;
            background: var(--controls-bg);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .controls-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
        }

        .camera-button {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--assistant-bg);
            color: var(--text);
            font-size: 26px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .camera-button:active { transform: scale(0.93); }

        .camera-button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: #e94560;
            color: white;
            font-size: 36px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
            -webkit-tap-highlight-color: transparent;
        }
        
        .mic-button:active {
            transform: scale(0.95);
        }
        
        .mic-button.listening {
            background: #4ecca3;
            animation: pulse 1.5s infinite;
        }
        
        .mic-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 20px rgba(78, 204, 163, 0.4);
            }
            50% {
                box-shadow: 0 4px 40px rgba(78, 204, 163, 0.8);
            }
        }
        
        .status {
            text-align: center;
            font-size: 14px;
            color: var(--status-color);
        }
        
        .settings-button {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--modal-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--label-color);
        }

        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-secondary {
            background: var(--assistant-bg);
            color: var(--text);
        }

        /* Toggle Switch (Sprachausgabe) */
        .toggle-switch { position:relative; display:inline-block; width:46px; height:26px; flex-shrink:0; }
        .toggle-switch input { opacity:0; width:0; height:0; }
        .toggle-slider {
            position:absolute; cursor:pointer; inset:0;
            background:#555; border-radius:26px; transition:.25s;
        }
        .toggle-slider:before {
            content:""; position:absolute;
            width:20px; height:20px; left:3px; bottom:3px;
            background:white; border-radius:50%; transition:.25s;
        }
        .toggle-switch input:checked + .toggle-slider { background:#e94560; }
        .toggle-switch input:checked + .toggle-slider:before { transform:translateX(20px); }
        
        .error {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        /* ‚îÄ‚îÄ Schnellzugriff-Chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .quick-chips {
            display: flex;
            gap: 8px;
            padding: 10px 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            border-top: 1px solid var(--border);
            background: var(--controls-bg);
            flex-shrink: 0;
        }
        .quick-chips:empty { display: none; }
        .quick-chips::-webkit-scrollbar { display: none; }

        .chip {
            flex-shrink: 0;
            padding: 7px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--assistant-bg);
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s, border-color 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .chip:active {
            background: rgba(233, 69, 96, 0.2);
            border-color: #e94560;
        }

        .star-btn {
            display: inline-block;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 17px;
            line-height: 1;
            padding: 6px 0 0 8px;
            opacity: 0.45;
            float: right;
            transition: opacity 0.15s, transform 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .star-btn.starred { opacity: 1; }
        .star-btn:active { transform: scale(1.35); }
    </style>
</head>
<body>
    <div class="header">
        <button class="settings-button" onclick="openSettings()">‚öôÔ∏è Setup</button>
        <h1>üöó Cupra Tavascan</h1>
        <div style="position:absolute; top:15px; right:15px; display:flex; align-items:center; gap:8px;">
            <button id="themeToggle" onclick="toggleTheme()" style="background:rgba(255,255,255,0.15); border:none; color:var(--text); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:18px; line-height:1;" title="Hell/Dunkel wechseln">üåô</button>
            <div class="setup-indicator" id="setupIndicator"></div>
        </div>
    </div>
    
    <div class="conversation" id="conversation">
        <div class="message assistant-message">
            Willkommen! Tippe oben auf "‚öôÔ∏è Setup", um deinen API-Key einzugeben.
        </div>
    </div>
    
    <div class="quick-chips" id="quickChips"></div>

    <div class="controls">
        <div class="controls-buttons">
            <button class="camera-button" id="cameraButton" disabled title="Foto aufnehmen / hochladen">üì∑</button>
            <button class="mic-button" id="micButton" disabled>üé§</button>
        </div>
        <div class="status" id="status">Bitte erst Setup durchf√ºhren</div>
    </div>
    <input type="file" id="imageInput" accept="image/*" style="display:none;">

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Einrichtung / Setup</h2>

            <div class="form-group">
                <label>Claude API Key</label>
                <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
                <small style="color:var(--status-color);font-size:12px;">
                    Erh√§ltlich unter: <a href="https://console.anthropic.com/" target="_blank" style="color:#4ecca3;">console.anthropic.com</a>
                </small>
            </div>

            <div class="form-group">
                <label>Sprache / Language</label>
                <div style="display:flex;gap:24px;margin-top:8px;">
                    <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:15px;">
                        <input type="radio" name="lang" id="langDe" value="de" style="accent-color:#e94560;width:16px;height:16px;"> Deutsch
                    </label>
                    <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:15px;">
                        <input type="radio" name="lang" id="langEn" value="en" style="accent-color:#e94560;width:16px;height:16px;"> English
                    </label>
                </div>
            </div>

            <div class="form-group" style="margin-bottom:4px;">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                    <label style="margin:0;font-size:15px;">üîä Sprachausgabe / Voice output</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="ttsToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeSettings()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveSettings()">Speichern</button>
            </div>

            <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                <button class="btn btn-secondary" onclick="exportHistory()" style="width:100%;">
                    üìã Gespr√§ch exportieren / Export History
                </button>
            </div>

            <div id="versionInfo" style="margin-top:14px;text-align:center;font-size:11px;opacity:0.4;letter-spacing:0.02em;">
                ‚Äì
            </div>
        </div>
    </div>

    <script>
        // State Management
        const MANUAL_URL = 'anleitung_tavascan.md';

        let config = {
            apiKey: localStorage.getItem('claude_api_key') || '',
            lang: localStorage.getItem('lang') || 'de',
            tts: localStorage.getItem('tts') !== 'false'
        };

        // ‚îÄ‚îÄ √úbersetzungen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const T = {
            de: {
                welcome:     'Hallo Horst! Dr√ºcke den Mikrofon-Button und stelle deine Frage zum Cupra Tavascan.',
                ready:       'Bereit zum Zuh√∂ren',
                listening:   'Ich h√∂re zu...',
                thinking:    'Claude denkt nach...',
                errorRetry:  'Fehler ‚Äì nochmal versuchen',
                noSpeech:    'Keine Sprache erkannt ‚Äì nochmal versuchen',
                micDenied:   'Mikrofon-Zugriff verweigert',
                setupNeeded: 'Bitte erst Setup durchf√ºhren',
                cached:      '(gespeichert)',
                noSpeechRec: 'Spracherkennung wird von diesem Browser leider nicht unterst√ºtzt.',
                noSpeechAlert: 'Spracherkennung wird von diesem Browser nicht unterst√ºtzt.',
                noExport:    'Noch kein Gespr√§ch zum Exportieren.',
                exportLabel: 'Gespr√§chsverlauf',
                exportedAt:  'Exportiert',
                horst:       'Horst',
                assistant:   'Assistent',
                manualPrefix: 'Relevante Ausz√ºge aus der Cupra Tavascan Bedienungsanleitung:',
                questionLabel: 'Frage von Horst',
                ttsLabel: 'Sprachausgabe',
                star:   'Als Favorit speichern',
                unstar: 'Aus Favoriten entfernen',
            },
            en: {
                welcome:     'Hello! Press the microphone button and ask your question about the Cupra Tavascan.',
                ready:       'Ready to listen',
                listening:   'Listening...',
                thinking:    'Claude is thinking...',
                errorRetry:  'Error ‚Äì please try again',
                noSpeech:    'No speech detected ‚Äì please try again',
                micDenied:   'Microphone access denied',
                setupNeeded: 'Please complete setup first',
                cached:      '(cached)',
                noSpeechRec: 'Speech recognition is not supported by this browser.',
                noSpeechAlert: 'Speech recognition is not supported by this browser.',
                noExport:    'No conversation to export yet.',
                exportLabel: 'Conversation History',
                exportedAt:  'Exported',
                horst:       'Horst',
                assistant:   'Assistant',
                manualPrefix: 'Relevant excerpts from the Cupra Tavascan owner\'s manual:',
                questionLabel: 'Question',
                ttsLabel: 'Voice output',
                star:   'Save as favourite',
                unstar: 'Remove from favourites',
            }
        };
        function t(key) { return T[config.lang]?.[key] ?? T.de[key]; }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        let isListening = false;
        let recognition;
        let conversationHistory = [];
        let manualContent = null;
        
        // Theme Toggle
        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            document.getElementById('themeToggle').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // ‚îÄ‚îÄ Offline Q&A Cache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const QA_CACHE_KEY = 'tavascan_qa_cache';
        const QA_CACHE_MAX = 100;
        // ‚îÄ‚îÄ Favoriten / Schnellzugriff ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const FAVS_KEY = 'tavascan_favorites';
        const FAVS_MAX = 8;

        function loadFavs() {
            try { return JSON.parse(localStorage.getItem(FAVS_KEY) || '[]'); }
            catch { return []; }
        }

        function saveFav(question, answer) {
            const favs = loadFavs();
            if (favs.some(f => f.question === question)) return;
            favs.unshift({ question, answer });
            if (favs.length > FAVS_MAX) favs.splice(FAVS_MAX);
            localStorage.setItem(FAVS_KEY, JSON.stringify(favs));
            renderChips();
        }

        function removeFav(question) {
            const favs = loadFavs().filter(f => f.question !== question);
            localStorage.setItem(FAVS_KEY, JSON.stringify(favs));
            renderChips();
        }

        function isFav(question) {
            return loadFavs().some(f => f.question === question);
        }

        function renderChips() {
            const favs = loadFavs();
            const container = document.getElementById('quickChips');
            container.innerHTML = '';
            for (const fav of favs) {
                const btn = document.createElement('button');
                btn.className = 'chip';
                const label = fav.question.length > 32 ? fav.question.slice(0, 30) + '‚Ä¶' : fav.question;
                btn.textContent = '‚≠ê ' + label;
                btn.title = fav.question;
                btn.addEventListener('click', () => {
                    addMessage('user', fav.question);
                    addMessage('assistant', fav.answer, true);
                    if (config.tts) speakText(fav.answer);
                    const conv = document.getElementById('conversation');
                    conv.scrollTop = conv.scrollHeight;
                });
                container.appendChild(btn);
            }
        }

        function qaCache() {
            try { return JSON.parse(localStorage.getItem(QA_CACHE_KEY) || '[]'); }
            catch { return []; }
        }

        function saveToQACache(question, answer) {
            const cache = qaCache();
            const idx = cache.findIndex(e => e.question === question);
            if (idx >= 0) cache.splice(idx, 1);
            cache.unshift({ question, answer, ts: Date.now() });
            if (cache.length > QA_CACHE_MAX) cache.splice(QA_CACHE_MAX);
            localStorage.setItem(QA_CACHE_KEY, JSON.stringify(cache));
        }

        function findInQACache(question) {
            const cache = qaCache();
            const keywords = question.toLowerCase()
                .split(/\s+/)
                .map(w => w.replace(/[^a-z√§√∂√º√ü]/g, ''))
                .filter(w => w.length > 3);
            if (keywords.length === 0) return null;
            let best = null, bestScore = 0;
            for (const entry of cache) {
                const entryLower = entry.question.toLowerCase();
                const score = keywords.filter(kw => entryLower.includes(kw)).length / keywords.length;
                if (score > bestScore) { bestScore = score; best = entry; }
            }
            return bestScore >= 0.7 ? best : null;
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // Initialize
        let lastQuestion = '';

        // Version aus version.json laden (wird vom CI-Build erzeugt)
        function loadVersion() {
            fetch('version.json')
                .then(r => { if (!r.ok) throw new Error(); return r.json(); })
                .then(v => {
                    document.getElementById('versionInfo').textContent =
                        `v${v.version} ¬∑ ${v.buildDate}`;
                })
                .catch(() => {
                    // Fallback im lokalen Dev-Betrieb
                    document.getElementById('versionInfo').textContent =
                        `Dev ¬∑ ${new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadConfig();
            initSpeechRecognition();
            updateSetupIndicator();
            renderChips();
            loadVersion();
            
            // Service Worker registrieren
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('Service Worker Registrierung fehlgeschlagen:', err);
                });
                // Wenn ein neuer SW die Kontrolle √ºbernimmt (nach skipWaiting +
                // clients.claim), Seite neu laden ‚Üí Horst sieht sofort das Update.
                // localStorage (API-Key, Cache, Favoriten) bleibt dabei erhalten.
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            }
        });
        
        // Load saved configuration
        function loadConfig() {
            if (config.apiKey) {
                document.getElementById('micButton').disabled = false;
                document.getElementById('cameraButton').disabled = false;
                document.getElementById('status').textContent = t('ready');
                addMessage('assistant', t('welcome'));
            } else {
                document.getElementById('status').textContent = t('setupNeeded');
            }
        }

        // Fetch manual from GitHub (gecacht)
        async function fetchManual() {
            if (manualContent) return manualContent;
            const response = await fetch(MANUAL_URL);
            if (!response.ok) {
                throw new Error(`Anleitung konnte nicht geladen werden (HTTP ${response.status})`);
            }
            manualContent = await response.text();
            return manualContent;
        }
        
        // Update setup indicator
        function updateSetupIndicator() {
            const indicator = document.getElementById('setupIndicator');
            if (config.apiKey) {
                indicator.classList.add('ready');
            } else {
                indicator.classList.remove('ready');
            }
        }
        
        // Settings Modal
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('apiKeyInput').value = config.apiKey;
            const langRadio = document.querySelector(`input[name="lang"][value="${config.lang}"]`);
            if (langRadio) langRadio.checked = true;
            document.getElementById('ttsToggle').checked = config.tts;
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        async function saveSettings() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const lang = document.querySelector('input[name="lang"]:checked')?.value || 'de';

            if (!apiKey) {
                alert(lang === 'en' ? 'Please enter your Claude API Key.' : 'Bitte gib deinen Claude API Key ein.');
                return;
            }

            const tts = document.getElementById('ttsToggle').checked;
            config.apiKey = apiKey;
            config.lang = lang;
            config.tts = tts;
            localStorage.setItem('claude_api_key', apiKey);
            localStorage.setItem('lang', lang);
            localStorage.setItem('tts', tts);

            updateSetupIndicator();
            document.getElementById('micButton').disabled = false;
            document.getElementById('cameraButton').disabled = false;
            document.getElementById('status').textContent = t('ready');

            setTimeout(() => {
                closeSettings();
                location.reload();
            }, 500);
        }
        
        // Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = config.lang === 'en' ? 'en-US' : 'de-DE';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = async (event) => {
                    const transcript = event.results[0][0].transcript;
                    lastQuestion = transcript;
                    addMessage('user', transcript);
                    stopListening();

                    // Offline-Cache pr√ºfen
                    const cached = findInQACache(transcript);
                    if (cached) {
                        addMessage('assistant', cached.answer, true);
                        if (config.tts) speakText(cached.answer);
                        document.getElementById('status').textContent = t('ready');
                        return;
                    }

                    document.getElementById('status').textContent = t('thinking');

                    try {
                        const response = await askClaude(transcript);
                        saveToQACache(transcript, response);
                        addMessage('assistant', response);
                        if (config.tts) speakText(response);
                        document.getElementById('status').textContent = t('ready');
                    } catch (error) {
                        const errorText = error.message || 'Unbekannter Fehler';
                        addMessage('assistant', `Fehler: ${errorText}`);
                        document.getElementById('status').textContent = t('errorRetry');
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech Recognition Error:', event.error);
                    stopListening();
                    let msg = t('errorRetry');
                    if (event.error === 'no-speech')      msg = t('noSpeech');
                    if (event.error === 'audio-capture')  msg = t('micDenied');
                    document.getElementById('status').textContent = msg;
                };

                recognition.onend = () => {
                    if (isListening) stopListening();
                };
            } else {
                console.error('Speech Recognition nicht unterst√ºtzt');
                addMessage('assistant', t('noSpeechRec'));
            }
        }
        
        // Microphone Button
        document.getElementById('micButton').addEventListener('click', () => {
            if (!config.apiKey) {
                openSettings();
                return;
            }

            // iOS Safari: TTS muss beim ersten User-Gesture entsperrt werden,
            // sonst blockiert iOS den speak()-Aufruf nach async-Operationen.
            unlockTTS();

            if (!isListening) {
                startListening();
            } else {
                stopListening();
            }
        });

        // Camera Button
        document.getElementById('cameraButton').addEventListener('click', () => {
            if (!config.apiKey) { openSettings(); return; }
            unlockTTS(); // iOS Safari: TTS im User-Gesture-Kontext entsperren
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = ''; // Reset f√ºr erneute Auswahl derselben Datei
            lastQuestion = '';       // kein Stern-Button f√ºr Foto-Antworten

            const reader = new FileReader();
            reader.onload = async (e) => {
                // Bild auf max. 1920 px skalieren + als JPEG komprimieren (Claude-Limit: 5 MB)
                const compressed = await compressImage(e.target.result);
                const base64 = compressed.split(',')[1];

                addImageMessage(compressed);
                document.getElementById('status').textContent = t('thinking');

                try {
                    const response = await askClaudeWithImage(base64, 'image/jpeg');
                    addMessage('assistant', response);
                    if (config.tts) speakText(response);
                    document.getElementById('status').textContent = t('ready');
                } catch (error) {
                    addMessage('assistant', `Fehler: ${error.message}`);
                    document.getElementById('status').textContent = t('errorRetry');
                }
            };
            reader.readAsDataURL(file);
        });

        // Bild auf max. 1920 px skalieren und als JPEG komprimieren
        function compressImage(dataUrl, maxPx = 1920, quality = 0.82) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onerror = () => resolve(dataUrl); // Fallback: Original unver√§ndert nutzen
                img.onload = () => {
                    let { width, height } = img;
                    if (width > maxPx || height > maxPx) {
                        if (width >= height) { height = Math.round(height * maxPx / width); width = maxPx; }
                        else                  { width = Math.round(width * maxPx / height); height = maxPx; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }

        function addImageMessage(dataUrl) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            const img = document.createElement('img');
            img.src = dataUrl;
            img.style.cssText = 'max-width:100%;max-height:220px;border-radius:8px;display:block;';
            messageDiv.appendChild(img);
            const conversation = document.getElementById('conversation');
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
            conversationHistory.push({ role: 'user', content: config.lang === 'en' ? '[Photo uploaded]' : '[Foto hochgeladen]' });
        }

        function startListening() {
            if (!recognition) {
                alert(t('noSpeechAlert'));
                return;
            }
            isListening = true;
            document.getElementById('micButton').classList.add('listening');
            document.getElementById('status').textContent = t('listening');
            try {
                recognition.start();
            } catch (error) {
                console.error('Fehler beim Starten der Spracherkennung:', error);
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('micButton').classList.remove('listening');
            document.getElementById('status').textContent = t('ready');
            if (recognition) {
                try { recognition.stop(); } catch (e) { /* ignorieren */ }
            }
        }
        
        // Add message to conversation
        function addMessage(role, text, fromCache = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role === 'user' ? 'user-message' : 'assistant-message'}`;
            messageDiv.textContent = text;
            if (fromCache) {
                const badge = document.createElement('span');
                badge.textContent = ' ' + t('cached');
                badge.style.cssText = 'font-size:11px;opacity:0.6;display:block;margin-top:4px;';
                messageDiv.appendChild(badge);
            }
            // Stern-Button f√ºr Assistenten-Antworten auf Sprachfragen
            if (role === 'assistant' && lastQuestion) {
                const q = lastQuestion;
                const a = text;
                const starred = isFav(q);
                const starBtn = document.createElement('button');
                starBtn.className = 'star-btn' + (starred ? ' starred' : '');
                starBtn.textContent = starred ? '‚≠ê' : '‚òÜ';
                starBtn.title = starred ? t('unstar') : t('star');
                starBtn.addEventListener('click', () => {
                    if (isFav(q)) {
                        removeFav(q);
                        starBtn.textContent = '‚òÜ';
                        starBtn.classList.remove('starred');
                        starBtn.title = t('star');
                        starBtn.style.opacity = '';
                    } else {
                        saveFav(q, a);
                        starBtn.textContent = '‚≠ê';
                        starBtn.classList.add('starred');
                        starBtn.title = t('unstar');
                    }
                });
                messageDiv.appendChild(starBtn);
            }
            
            const conversation = document.getElementById('conversation');
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
            
            // Zur History hinzuf√ºgen (aber nicht die erste Willkommensnachricht)
            if (conversationHistory.length > 0 || role === 'user') {
                conversationHistory.push({ role, content: text });
            }
        }
        
        // Relevante Abschnitte aus der Anleitung extrahieren (keyword-basiert)
        function extractRelevantSections(manual, question) {
            const lines = manual.split('\n');

            // Schl√ºsselw√∂rter: ‚â•3 Zeichen; zus√§tzlich rudiment√§re Stammformen
            const raw = question.toLowerCase()
                .split(/\s+/)
                .map(w => w.replace(/[^a-z√§√∂√º√ü]/g, ''))
                .filter(w => w.length >= 3);

            const keywords = new Set(raw);
            for (const w of raw) {
                // H√§ufige deutsche Flexionsendungen k√ºrzen ‚Üí Stammform
                if (w.endsWith('ung')  && w.length > 5) keywords.add(w.slice(0, -3));
                if (w.endsWith('ungen')&& w.length > 6) keywords.add(w.slice(0, -5));
                if (w.endsWith('ieren')&& w.length > 6) keywords.add(w.slice(0, -5));
                if (w.endsWith('ern')  && w.length > 5) keywords.add(w.slice(0, -3));
                if (w.endsWith('ern')  && w.length > 5) keywords.add(w.slice(0, -2));
                if (w.endsWith('en')   && w.length > 4) keywords.add(w.slice(0, -2));
                if (w.endsWith('er')   && w.length > 4) keywords.add(w.slice(0, -2));
                if (w.endsWith('es')   && w.length > 4) keywords.add(w.slice(0, -2));
                if (w.endsWith('em')   && w.length > 4) keywords.add(w.slice(0, -2));
                if (w.endsWith('e')    && w.length > 4) keywords.add(w.slice(0, -1));
            }
            const kwList = [...keywords].filter(k => k.length >= 3);

            if (kwList.length === 0) return manual.slice(0, 100000);

            const included = new Set();
            // Erste 40 Zeilen (Inhaltsverzeichnis) immer einschlie√üen
            for (let j = 0; j < Math.min(40, lines.length); j++) included.add(j);

            lines.forEach((line, i) => {
                const lower = line.toLowerCase();
                if (kwList.some(kw => lower.includes(kw))) {
                    // Mehr Kontext: 10 Zeilen vor, 80 Zeilen nach dem Treffer
                    for (let j = Math.max(0, i - 10); j <= Math.min(lines.length - 1, i + 80); j++) {
                        included.add(j);
                    }
                }
            });

            let result = '';
            let prev = -2;
            [...included].sort((a, b) => a - b).forEach(idx => {
                if (idx > prev + 1) result += '\n---\n';
                result += lines[idx] + '\n';
                prev = idx;
            });

            // Falls Extraktion zu wenig ergab, sicherheitshalber mehr vom Anfang hinzunehmen
            if (result.length < 8000) {
                result = manual.slice(0, 100000);
            }

            return result.length > 120000 ? result.slice(0, 120000) : result;
        }

        // System-Prompt (sprachabh√§ngig)
        function getSystemPrompt() {
            return config.lang === 'en'
                ? `You are Horst's personal Cupra Tavascan expert. Horst is 75 years old, has little patience and needs short, clear answers without detours.

HOW TO RESPOND:
1. SHORT and DIRECT ‚Äì Maximum 2-3 sentences. Give more details only when Horst asks.
2. ONE solution ‚Äì Do NOT mention multiple options or alternatives. Tell him exactly what to do.
3. STEP by STEP ‚Äì Number the steps (1., 2., 3.). One step = one action.
4. SIMPLE LANGUAGE ‚Äì As if explaining to a friend. No technical jargon.
5. STAY PATIENT ‚Äì Be friendly and helpful even with repeated questions.

IMPORTANT FOR VOICE OUTPUT:
- Keep answers as short as possible (Horst listens on his phone)
- For long instructions: Give the first 2 steps first, then continue on request
- No long introductions like "I'd be happy to help you..."

Use only the attached owner's manual as your knowledge source. Answer in English.`
                : `Du bist Horsts pers√∂nlicher Cupra Tavascan Experte. Horst ist 75 Jahre alt, hat wenig Geduld und braucht kurze, klare Antworten ohne Umschweife.

SO ANTWORTEST DU:
1. KURZ und DIREKT ‚Äì Maximal 2-3 S√§tze. Erst wenn Horst nachfragt, gibst du mehr Details.
2. EINE L√∂sung ‚Äì Nenne NICHT mehrere Optionen oder Alternativen. Sag ihm genau, was er tun soll.
3. SCHRITT f√ºr SCHRITT ‚Äì Nummeriere die Schritte (1., 2., 3.). Ein Schritt = eine Aktion.
4. EINFACHE SPRACHE ‚Äì Als w√ºrdest du es einem Freund erkl√§ren. Kein Fachchinesisch.
5. GEDULDIG BLEIBEN ‚Äì Auch bei wiederholten Fragen freundlich und hilfsbereit sein.

WICHTIG F√úR SPRACHAUSGABE:
- Halte Antworten so kurz wie m√∂glich (Horst h√∂rt sie am Handy)
- Bei langen Anleitungen: Erst die ersten 2 Schritte, dann auf Nachfrage weitermachen
- Keine langen Einleitungen wie "Gerne helfe ich dir dabei..."

Nutze nur die unten angeh√§ngte Bedienungsanleitung als Wissensquelle.`;
        }

        // Ask Claude via API (Texteingabe)
        async function askClaude(question) {
            let manualSection;
            try {
                const manual = await fetchManual();
                manualSection = extractRelevantSections(manual, question);
            } catch (e) {
                throw new Error(`Anleitung laden fehlgeschlagen: ${e.message}`);
            }

            const userText = `${t('manualPrefix')}\n\n${manualSection}\n\n${t('questionLabel')}: ${question}`;

            // Max. 20 Eintr√§ge (= 10 Gespr√§chswechsel) mitnehmen, Rest verwerfen
            const recentHistory = conversationHistory.slice(-20);
            const messages = [
                ...recentHistory.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'assistant',
                    content: msg.content
                })),
                { role: 'user', content: userText }
            ];

            let response;
            try {
                response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': config.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 800,
                        system: getSystemPrompt(),
                        messages: messages
                    })
                });
            } catch (e) {
                throw new Error(`API nicht erreichbar: ${e.message}`);
            }

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Fehler ${response.status}: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            if (data.content && data.content[0] && data.content[0].text) {
                return data.content[0].text;
            }
            throw new Error('Unerwartete API-Antwort');
        }

        // Ask Claude via API (Bildanalyse)
        async function askClaudeWithImage(base64, mediaType) {
            let manualSection = '';
            try {
                const manual = await fetchManual();
                const searchTerm = config.lang === 'en'
                    ? 'warning error display indicator light'
                    : 'Warnung Fehlermeldung Anzeige Kontrollleuchte';
                manualSection = extractRelevantSections(manual, searchTerm);
            } catch (e) { /* Anleitung optional bei Bildanalyse */ }

            const imagePrompt = config.lang === 'en'
                ? `Horst has taken a photo of his Cupra Tavascan (probably the display or a warning light).\n\nPlease:\n1. Describe briefly what you see in the image\n2. Explain what it means\n3. Tell Horst exactly what to do\n\nRelevant manual sections for reference:\n\n${manualSection}`
                : `Horst hat ein Foto von seinem Cupra Tavascan aufgenommen (wahrscheinlich vom Display oder einer Warnanzeige).\n\nBitte:\n1. Beschreibe kurz, was du auf dem Bild siehst\n2. Erkl√§re, was das bedeutet\n3. Sag Horst genau, was er tun soll\n\nRelevante Abschnitte aus der Bedienungsanleitung zur Orientierung:\n\n${manualSection}`;

            const userContent = [
                { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
                { type: 'text', text: imagePrompt }
            ];

            let response;
            try {
                response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': config.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 800,
                        system: getSystemPrompt(),
                        messages: [{ role: 'user', content: userContent }]
                    })
                });
            } catch (e) {
                throw new Error(`API nicht erreichbar: ${e.message}`);
            }

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Fehler ${response.status}: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            if (data.content && data.content[0] && data.content[0].text) {
                return data.content[0].text;
            }
            throw new Error('Unerwartete API-Antwort');
        }
        
        // Text-to-Speech
        let ttsUnlocked = false;
        let ttsKeepAlive = null;

        // iOS Safari: speak() muss einmal im User-Gesture-Kontext aufgerufen
        // werden, sonst wird es nach async-Operationen blockiert.
        function unlockTTS() {
            if (ttsUnlocked || !window.speechSynthesis) return;
            const silent = new SpeechSynthesisUtterance('');
            silent.volume = 0;
            window.speechSynthesis.speak(silent);
            ttsUnlocked = true;
        }

        function speakText(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            clearInterval(ttsKeepAlive);

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = config.lang === 'en' ? 'en-US' : 'de-DE';
            utterance.rate = 0.85;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            // iOS Safari bricht TTS nach ~15 s ab ‚Äì pause/resume h√§lt es am Laufen
            ttsKeepAlive = setInterval(() => {
                if (!window.speechSynthesis.speaking) {
                    clearInterval(ttsKeepAlive);
                    return;
                }
                window.speechSynthesis.pause();
                window.speechSynthesis.resume();
            }, 10000);

            utterance.onend = () => clearInterval(ttsKeepAlive);
            utterance.onerror = () => clearInterval(ttsKeepAlive);

            window.speechSynthesis.speak(utterance);
        }

        // ‚îÄ‚îÄ Conversation History Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function exportHistory() {
            if (conversationHistory.length === 0) {
                alert(t('noExport'));
                return;
            }
            const dateStr = new Date().toLocaleString(config.lang === 'en' ? 'en-US' : 'de-DE');
            const sep = '‚îÄ'.repeat(50);
            let text = `Cupra Tavascan Assistent ‚Äì ${t('exportLabel')}\n`;
            text += `${t('exportedAt')}: ${dateStr}\n${sep}\n\n`;
            for (const msg of conversationHistory) {
                const role = msg.role === 'user' ? t('horst') : t('assistant');
                text += `${role}:\n${msg.content}\n\n`;
            }
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tavascan-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    </script>
</body>
</html>
